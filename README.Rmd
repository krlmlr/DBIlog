---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
pkgload::load_all()
```

# DBIlog

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/DBIlog)](https://cran.r-project.org/package=DBIlog)
<!-- badges: end -->

The goal of DBIlog is to implement logging for arbitrary DBI backends, similarly to Perl's [DBI::Log](https://metacpan.org/pod/DBI::Log).
This is useful for troubleshooting and auditing codes that access a database.
The initial use case for this package is to help debugging DBItest tests.

## Installation

You can install the released version of DBIlog from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("DBIlog")
```

Install the development version from GitHub using

``` r
# install.packages("devtools")
devtools::install_github("r-dbi/DBIlog")
```


## Basic example

The `LoggingDBI` driver wraps arbitrary drivers:

```{r init}
library(DBIlog)
drv <- LoggingDBI(RSQLite::SQLite())
```


All calls to DBI methods are logged, by default to the console.

```{r console}
conn <- dbConnect(drv, file = ":memory:")
dbWriteTable(conn, "iris", iris[1:3, ])
data <- dbGetQuery(conn, "SELECT * FROM iris")
dbDisconnect(conn)

data
```

The log is runnable R code!
Run it in a fresh session to repeat the operations, step by step or in an otherwise controlled fashion.

DBIlog is smart about DBI objects created or returned, and will assign a new variable name to each new object.
Cleared results or closed connections are not removed automatically.

## Logging options

Logging can be redirected to a file, optionally all outputs may be logged as well.
For example, use a collecting logger to output all calls and results after the fact.


```{r collect}
collecting_logger <- make_collect_logger()

drv <- LoggingDBI(RSQLite::SQLite(), logger = collecting_logger)
conn <- dbConnect(drv, file = ":memory:")
dbWriteTable(conn, "iris", iris[1:3, ])
data <- dbGetQuery(conn, "SELECT * FROM iris")
dbDisconnect(conn)

collecting_logger$retrieve()

ev <- evaluate::evaluate(collecting_logger$retrieve())
cat(unlist(ev, use.names = FALSE), sep = "\n")
```

## Logging complex operations

The full power is demonstrated when running with code where the underlying _DBI_ operations are not obvious:

```{r dplyr}
library(dplyr)

drv <- LoggingDBI(RSQLite::SQLite())
conn <- dbConnect(drv, file = ":memory:")
dbWriteTable(conn, "iris", iris[1:3, ])

src <- dbplyr::src_dbi(conn)
iris_tbl <- tbl(src, "iris")
iris_tbl %>%
  summarize_if(is.numeric, mean)
```

